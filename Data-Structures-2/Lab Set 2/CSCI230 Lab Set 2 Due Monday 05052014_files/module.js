M.message_badge=M.message_badge||{};M.message_badge.initDone=false;M.message_badge.alertListOverlay=undefined;M.message_badge.messageOverlay=undefined;M.message_badge.activeMessageId=undefined;M.message_badge.forwardURL=undefined;M.message_badge.init_badge=function(Y,forwardURL){var badge=Y.one('.message_badge');if(!badge)return;badge.removeClass('message_badge_hidden');M.message_badge.forwardURL=forwardURL;badge.on('click',function(event){M.message_badge.init_overlay(Y,function(){var overlay=M.message_badge.alertListOverlay;if(!overlay.get('visible')){overlay.set('align',M.message_badge.align_alert_list_overlay(Y,badge));overlay.show();event.stopPropagation();var subscriber=Y.delegate('click',function(e){if(overlay.get('visible')&&!e.target.ancestor('.message_badge_container')&&!e.target.ancestor('#helppopupbox')){overlay.hide();M.message_badge.hide_message_overlay(Y);subscriber.detach()}},'body','body')}})})};M.message_badge.init_overlay=function(Y,callback){if(M.message_badge.initDone){if(typeof callback=='function')callback();return};M.message_badge.initDone=true;M.message_badge.get_messages_html(Y,function(){var badge=Y.one('.message_badge'),container=Y.one('.message_badge_container'),overlayNode=Y.one('.message_badge_overlay');container.appendTo(Y.one('body'));overlayNode.removeClass('message_badge_hidden');var overlay=new Y.Overlay({srcNode:overlayNode,visible:false,zIndex:1001,align:M.message_badge.align_alert_list_overlay(Y,badge)});overlay.render();M.message_badge.alertListOverlay=overlay;overlay.get('srcNode').all('.message_badge_message').each(function(node){M.message_badge.init_message(Y,node)});M.message_badge.init_help_icons(Y);if(typeof callback=='function')callback()})};M.message_badge.init_message=function(Y,messageNode){messageNode.all('.message_badge_contexturl').on('click',function(e){M.message_badge.forward(Y,messageNode,e)});messageNode.all('.message_badge_message_text a').on('click',function(e){M.message_badge.forward(Y,messageNode,e)});messageNode.one('.message_badge_ignoreurl').on('click',function(e){e.preventDefault();if(messageNode.get('id')==M.message_badge.activeMessageId){M.message_badge.hide_message_overlay(Y)}else{M.message_badge.ignore_message(Y,messageNode.one('.message_badge_ignoreurl').get('href'));messageNode.addClass('message_badge_hidden')}});messageNode.one('.message_badge_readurl').on('click',function(e){e.preventDefault();if(messageNode.get('id')!=M.message_badge.activeMessageId){M.message_badge.hide_message_overlay(Y);var overlay=new Y.Overlay({visible:false,zIndex:1e3});M.message_badge.populate_overlay(Y,overlay,messageNode.one('.message_badge_readurl').get('href'),function(unreadCount){overlay.get('srcNode').addClass('message_badge_message_overlay');messageNode.addClass('dimmed_text message_badge_message_opened');M.message_badge.update_unread_count(Y,unreadCount);overlay.get('srcNode').one('.message_badge_message_close a').on('click',function(e){e.preventDefault();M.message_badge.hide_message_overlay(Y)});overlay.after('visibleChange',function(e){if(!overlay.get('visible'))messageNode.addClass('message_badge_hidden')});if(M.message_badge.messageOverlay!=undefined){M.message_badge.messageOverlay.destroy();M.message_badge.messageOverlay=undefined};M.message_badge.messageOverlay=overlay;M.message_badge.activeMessageId=messageNode.get('id');overlay.set('align',M.message_badge.align_message_overlay(Y));overlay.show()})}})};M.message_badge.align_alert_list_overlay=function(Y,node){var centerX=(node.get('winWidth')/2),centerY=(node.get('winHeight')/2),x=node.getX(),y=node.getY(),points;if(x<=centerX&&y<=centerY){points=[Y.WidgetPositionAlign.TL,Y.WidgetPositionAlign.BL]}else if(x>=centerX&&y<=centerY){points=[Y.WidgetPositionAlign.TR,Y.WidgetPositionAlign.BR]}else if(x<=centerX&&y>=centerY){points=[Y.WidgetPositionAlign.BL,Y.WidgetPositionAlign.TL]}else if(x>=centerX&&y>=centerY)points=[Y.WidgetPositionAlign.BR,Y.WidgetPositionAlign.TR];return{node:node,points:points}};M.message_badge.align_message_overlay=function(Y){var badge=Y.one('.message_badge'),centerX=(badge.get('winWidth')/2),x=badge.getX(),points;if(x<=centerX){points=[Y.WidgetPositionAlign.TL,Y.WidgetPositionAlign.TR]}else points=[Y.WidgetPositionAlign.TR,Y.WidgetPositionAlign.TL];return{node:M.message_badge.alertListOverlay.get('srcNode'),points:points}};M.message_badge.hide_message_overlay=function(Y){if(M.message_badge.messageOverlay!=undefined)M.message_badge.messageOverlay.hide()};M.message_badge.ignore_message=function(Y,url){Y.io(url,{on:{success:function(id,o){var response=Y.JSON.parse(o.responseText);if(response.error!=undefined){alert(response.error)}else M.message_badge.update_unread_count(Y,response.args)},failure:function(id,o){alert(M.str.message_badge.genericasyncfail)}}})};M.message_badge.update_unread_count=function(Y,unreadCount){if(unreadCount>=1){Y.one('.message_badge_count').set('innerHTML',unreadCount)}else{Y.one('.message_badge_count').remove();Y.one('.message_badge_empty').removeClass('message_badge_hidden')}};M.message_badge.forward=function(Y,messageNode,e){var aNode=null;if(e.target.test('a')){aNode=e.target}else aNode=e.target.ancestor('a');if(aNode!==null){aNode.set('href',M.message_badge.forwardURL+'&messageid='+encodeURIComponent(messageNode.getAttribute('messageid'))+'&url='+encodeURIComponent(aNode.get('href')));aNode.target.removeAttribute('target')}};M.message_badge.populate_overlay=function(Y,overlay,url,onsuccess){Y.io(url,{on:{success:function(id,o){var response=Y.JSON.parse(o.responseText);if(response.error!=undefined){alert(response.error)}else{if(response.header!=undefined)overlay.set("headerContent",response.header);if(response.body!=undefined)overlay.set("bodyContent",response.body);if(response.footer!=undefined)overlay.set("footerContent",response.footer);overlay.render('.message_badge_container');if(typeof onsuccess=='function')if(response.args!=undefined){onsuccess(response.args)}else onsuccess()}},failure:function(id,o){alert(M.str.message_badge.genericasyncfail)}}})};M.message_badge.get_messages_html=function(Y,onsuccess){Y.io(M.cfg.wwwroot+'/message/output/badge/view.php?controller=ajax&action=getmessages',{on:{success:function(id,o){var response=Y.JSON.parse(o.responseText);if(response.error!=undefined){alert(response.error)}else{Y.one('.message_badge').get('parentNode').append(response.messages);if(typeof onsuccess=='function')onsuccess()}},failure:function(){alert(M.str.message_badge.genericasyncfail)}}})};M.message_badge.init_help_icons=function(Y){M.core.init_popuphelp([])}